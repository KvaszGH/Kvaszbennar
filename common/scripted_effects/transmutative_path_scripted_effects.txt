add_chi_wellspring_to_size = {
	if = {
		limit = {
			owner = { religion = transmutative_path }
			development = 10
		}
		remove_province_modifier = chi_wellspring_5
		remove_province_modifier = chi_wellspring_4
		remove_province_modifier = chi_wellspring_3
		remove_province_modifier = chi_wellspring_2
		remove_province_modifier = chi_wellspring_1
		if = {
			limit = { development = 50 }
			add_permanent_province_modifier = {
				name = chi_wellspring_5
				duration = -1
			}
		}
		else_if = {
			limit = { development = 40 }
			add_permanent_province_modifier = {
				name = chi_wellspring_4
				duration = -1
			}
		}
		else_if = {
			limit = { development = 30 }
			add_permanent_province_modifier = {
				name = chi_wellspring_3
				duration = -1
			}
		}
		else_if = {
			limit = { development = 20 }
			add_permanent_province_modifier = {
				name = chi_wellspring_2
				duration = -1
			}
		}
		else = {
			add_permanent_province_modifier = {
				name = chi_wellspring_1
				duration = -1
			}
		}
		set_province_flag = province_has_chi_wellspring

		if = {
			limit = { owner = { mission_completed = tp_xiaken_bathed_chi } }
			add_province_modifier = { name = xiaken_bathed_chi_mod duration = -1 }
		}
	}
}

transmutative_path_lower_chi_wellspring_to_size_effect = {
	if = {
		limit = { owner = { religion = transmutative_path } }
		if = {
			limit = {
				has_province_modifier = chi_wellspring_5
				NOT = { development = 50 }
			}
			remove_province_modifier = chi_wellspring_5
			add_devastation = 15
			add_permanent_province_modifier = {
				name = chi_wellspring_4
				duration = -1
			}
			owner = {
				if = {
					limit = { religion = transmutative_path }
					add_church_power = 5
					country_event = { id = transmutative_path.5 }
				}
			}
		}
		if = {
			limit = {
				has_province_modifier = chi_wellspring_4
				NOT = { development = 40 }
			}
			remove_province_modifier = chi_wellspring_4
			add_devastation = 15
			add_permanent_province_modifier = {
				name = chi_wellspring_3
				duration = -1
			}
			owner = {
				if = {
					limit = { religion = transmutative_path }
					add_church_power = 5
					country_event = { id = transmutative_path.5 }
				}
			}
		}
		if = {
			limit = {
				has_province_modifier = chi_wellspring_3
				NOT = { development = 30 }
			}
			remove_province_modifier = chi_wellspring_3
			add_devastation = 15
			add_permanent_province_modifier = {
				name = chi_wellspring_2
				duration = -1
			}
			owner = {
				if = {
					limit = { religion = transmutative_path }
					add_church_power = 5
					country_event = { id = transmutative_path.5 }
				}
			}
		}
		if = {
			limit = {
				has_province_modifier = chi_wellspring_2
				NOT = { development = 20 }
			}
			remove_province_modifier = chi_wellspring_2
			add_devastation = 15
			add_permanent_province_modifier = {
				name = chi_wellspring_1
				duration = -1
			}
			owner = {
				if = {
					limit = { religion = transmutative_path }
					add_church_power = 5
					country_event = { id = transmutative_path.5 }
				}
			}
		}
		if = {
			limit = {
				has_province_modifier = chi_wellspring_1
				NOT = { development = 10 }
			}
			remove_province_modifier = chi_wellspring_1
			add_devastation = 15
			clr_province_flag = province_has_chi_wellspring
			owner = {
				if = {
					limit = { religion = transmutative_path }
					add_church_power = 5
					country_event = { id = transmutative_path.5 }
				}
			}
		}
	}
}

transmutative_path_pay_chi_effect = {
	owner = {
		export_to_variable = { which = transmutative_path_dev_var value = development who = PREV }
		while = {
			limit = { check_variable = { transmutative_path_dev_var = 1 } }
			subtract_variable = { transmutative_path_dev_var = 1 }
			add_church_power = -3
		}
	}
}

transmutative_path_change_trade_good_effect = {
	owner = {
		trigger_switch = {
			on_trigger = has_church_aspect
			
			transmutative_path_tea_ceremonies = { PREV = { change_trade_goods = tea } }
			transmutative_path_dowsing_for_metals = { PREV = { change_trade_goods = copper } }
			transmutative_path_muzzle_the_ox = { PREV = { change_trade_goods = grain } }
			transmutative_path_strip_the_scales = { PREV = { change_trade_goods = gems } }
			transmutative_path_convert_pasture_lands = { PREV = { change_trade_goods = grain } }
			transmutative_path_weaving_weal = { PREV = { change_trade_goods = cloth } }
			transmutative_path_dessicate_landscape = { PREV = { change_trade_goods = salt } }
			transmutative_path_dredge_the_flats = { PREV = { change_trade_goods = gold } }
			transmutative_path_treadeth_the_corn = { PREV = { change_trade_goods = livestock } }
			transmutative_path_from_strings_to_silk = {
				PREV = {
					change_trade_goods = silk
					add_province_modifier = { name = transmutative_path_from_strings_to_silk_mod duration = -1 }
				}
			}
			transmutative_path_irrigate_jungle_plantations = {
				PREV = {
					change_trade_goods = coffee
					add_province_modifier = { name = transmutative_path_irrigate_jungle_plantations_mod duration = -1 }
				}
			}
			transmutative_path_flavor_of_life = { PREV = { change_trade_goods = sugar } }
		}
	}
}

transmutative_path_destroy_chi_wellspring_effect = {
	transmutative_path_destroy_chi_wellspring_to_size_effect = yes
	every_neighbor_province = {
		limit = {
			owned_by = $owner_scope$
			province_has_chi_wellspring_trigger = yes
		}
		transmutative_path_destroy_chi_wellspring_to_size_effect = yes
	}
}

transmutative_path_destroy_chi_wellspring_to_size_effect = {
	clr_province_flag = province_has_chi_wellspring

	trigger_switch = {
		on_trigger = has_province_modifier

		chi_wellspring_5 = {
			remove_province_modifier = chi_wellspring_5
			add_devastation = 35
			if = { limit = { owner = { religion = transmutative_path } } owner = { add_church_power = 35 } }
		}
		chi_wellspring_4 = {
			remove_province_modifier = chi_wellspring_4
			add_devastation = 30
			if = { limit = { owner = { religion = transmutative_path } } owner = { add_church_power = 30 } }
		}
		chi_wellspring_3 = {
			remove_province_modifier = chi_wellspring_3
			add_devastation = 25
			if = { limit = { owner = { religion = transmutative_path } } owner = { add_church_power = 25 } }
		}
		chi_wellspring_2 = {
			remove_province_modifier = chi_wellspring_2
			add_devastation = 20
			if = { limit = { owner = { religion = transmutative_path } } owner = { add_church_power = 20 } }
		}
		chi_wellspring_1 = {
			remove_province_modifier = chi_wellspring_1
			add_devastation = 15
			if = { limit = { owner = { religion = transmutative_path } } owner = { add_church_power = 15 } }
		}
	}

	remove_province_modifier = xiaken_bathed_chi_mod
}

# tracks church aspects and saves them in 3 slots (should be in correct order)
# FALSE POSITIVES EXIST (the slot flag exists, but the church aspect is not active)
# - there is no on_revoke for aspects
# - flags: $aspect$_slot_0/1/2 and transmutative_path_saved_slot_0/1/2
transmutative_path_track_aspect = {
	if = {
		limit = { ai = no }
		trigger_switch = {
			on_trigger = has_country_flag
			$aspect$_slot_0 = {
				clr_country_flag = $aspect$_slot_0
				clr_country_flag = transmutative_path_saved_slot_0
			}
			$aspect$_slot_1 = {
				clr_country_flag = $aspect$_slot_1
				clr_country_flag = transmutative_path_saved_slot_1
			}
			$aspect$_slot_2 = {
				clr_country_flag = $aspect$_slot_2
				clr_country_flag = transmutative_path_saved_slot_2
			}
		}

		hidden_effect = {
			country_event = { id = transmutative_path.0 } # clear invalid slots
		}

		if = {
			limit = { NOT = { has_country_flag = transmutative_path_saved_slot_0 } }
			set_country_flag = $aspect$_slot_0
			set_country_flag = transmutative_path_saved_slot_0
		}
		else_if = {
			limit = { NOT = { has_country_flag = transmutative_path_saved_slot_1 } }
			set_country_flag = $aspect$_slot_1
			set_country_flag = transmutative_path_saved_slot_1
		}
		else = {
			set_country_flag = $aspect$_slot_2
			set_country_flag = transmutative_path_saved_slot_2
		}
	}
}

# TRANS_CHURCH_ASPECT_INFUSE
# add church aspect here if it has infuse province effect
transmutative_path_clear_aspect_slot = {
	if = {
		limit = {
			has_country_flag = transmutative_path_acts_of_hermitage_slot_$slot$
			NOT = { has_church_aspect = transmutative_path_acts_of_hermitage }
		}
		transmutative_path_clear_aspect_slot_helper = { aspect = transmutative_path_acts_of_hermitage slot = $slot$ }
	}
	else_if = {
		limit = {
			has_country_flag = transmutative_path_rememberance_festival_slot_$slot$
			NOT = { has_church_aspect = transmutative_path_rememberance_festival }
		}
		transmutative_path_clear_aspect_slot_helper = { aspect = transmutative_path_rememberance_festival slot = $slot$ }
	}
	else_if = {
		limit = {
			has_country_flag = transmutative_path_sponsor_travelling_libraries_slot_$slot$
			NOT = { has_church_aspect = transmutative_path_sponsor_travelling_libraries }
		}
		transmutative_path_clear_aspect_slot_helper = { aspect = transmutative_path_sponsor_travelling_libraries slot = $slot$ }
	}
	else_if = {
		limit = {
			has_country_flag = transmutative_path_meditation_through_labour_slot_$slot$
			NOT = { has_church_aspect = transmutative_path_meditation_through_labour }
		}
		transmutative_path_clear_aspect_slot_helper = { aspect = transmutative_path_meditation_through_labour slot = $slot$ }
	}
	else_if = {
		limit = {
			has_country_flag = transmutative_path_fill_the_begging_bowls_slot_$slot$
			NOT = { has_church_aspect = transmutative_path_fill_the_begging_bowls }
		}
		transmutative_path_clear_aspect_slot_helper = { aspect = transmutative_path_fill_the_begging_bowls slot = $slot$ }
	}
	else_if = {
		limit = {
			has_country_flag = transmutative_path_relive_past_lives_slot_$slot$
			NOT = { has_church_aspect = transmutative_path_relive_past_lives }
		}
		transmutative_path_clear_aspect_slot_helper = { aspect = transmutative_path_relive_past_lives slot = $slot$ }
	}
	else_if = {
		limit = {
			has_country_flag = transmutative_path_universal_martial_education_slot_$slot$
			NOT = { has_church_aspect = transmutative_path_universal_martial_education }
		}
		transmutative_path_clear_aspect_slot_helper = { aspect = transmutative_path_universal_martial_education slot = $slot$ }
	}
	else_if = {
		limit = {
			has_country_flag = transmutative_path_leadership_of_hero_monks_slot_$slot$
			NOT = { has_church_aspect = transmutative_path_leadership_of_hero_monks }
		}
		transmutative_path_clear_aspect_slot_helper = { aspect = transmutative_path_leadership_of_hero_monks slot = $slot$ }
	}
	else_if = {
		limit = {
			has_country_flag = transmutative_path_hire_sellsword_monks_slot_$slot$
			NOT = { has_church_aspect = transmutative_path_hire_sellsword_monks }
		}
		transmutative_path_clear_aspect_slot_helper = { aspect = transmutative_path_hire_sellsword_monks slot = $slot$}
	}
	else_if = {
		limit = {
			has_country_flag = transmutative_path_everything_under_heaven_slot_$slot$
			NOT = { has_church_aspect = transmutative_path_everything_under_heaven }
		}
		transmutative_path_clear_aspect_slot_helper = { aspect = transmutative_path_everything_under_heaven slot = $slot$ }
	}
	else_if = {
		limit = {
			has_country_flag = transmutative_path_through_inaction_action_slot_$slot$
			NOT = { has_church_aspect = transmutative_path_through_inaction_action }
		}
		transmutative_path_clear_aspect_slot_helper = { aspect = transmutative_path_through_inaction_action slot = $slot$ }
	}
	else_if = {
		limit = {
			has_country_flag = transmutative_path_we_all_lift_together_slot_$slot$
			NOT = { has_church_aspect = transmutative_path_we_all_lift_together }
		}
		transmutative_path_clear_aspect_slot_helper = { aspect = transmutative_path_we_all_lift_together slot = $slot$ }
	}
	else_if = {
		limit = {
			has_country_flag = transmutative_path_the_second_ascension_$slot$
			NOT = { has_church_aspect = transmutative_path_the_second_ascension }
		}
		transmutative_path_clear_aspect_slot_helper = { aspect = transmutative_path_the_second_ascension slot = $slot$ }
	}
	else_if = {
		limit = {
			has_country_flag = transmutative_path_sages_of_the_misty_mountains_$slot$
			NOT = { has_church_aspect = transmutative_path_sages_of_the_misty_mountains }
		}
		transmutative_path_clear_aspect_slot_helper = { aspect = transmutative_path_sages_of_the_misty_mountains slot = $slot$ }
	}
	else_if = {
		limit = {
			has_country_flag = transmutative_path_flavor_of_life_$slot$
			NOT = { has_church_aspect = transmutative_path_flavor_of_life }
		}
		transmutative_path_clear_aspect_slot_helper = { aspect = transmutative_path_flavor_of_life slot = $slot$ }
	}
}

transmutative_path_clear_aspect_slot_helper = {
	clr_country_flag = $aspect$_slot_$slot$
	clr_country_flag = transmutative_path_saved_slot_$slot$
}

# TRANS_CHURCH_ASPECT_INFUSE
# add church aspect here if it has infuse province effect
transmutative_path_infuse_province_effect = {
	custom_tooltip = transmutative_path_pay_for_chi_preview
	hidden_effect = { transmutative_path_pay_chi_effect = yes }

	if = {
		limit = { FROM = { has_country_flag = transmutative_path_saved_slot_$slot$ } }
		if = {
			limit = {
				FROM = {
					has_country_flag = transmutative_path_acts_of_hermitage_slot_$slot$
					has_church_aspect = transmutative_path_acts_of_hermitage
				}
			}
			add_base_tax = 1
		}
		else_if = {
			limit = {
				FROM = {
					has_country_flag = transmutative_path_rememberance_festival_slot_$slot$
					has_church_aspect = transmutative_path_rememberance_festival
				}
			}
			add_unrest = -10
		}
		else_if = {
			limit = {
				FROM = {
					has_country_flag = transmutative_path_sponsor_travelling_libraries_slot_$slot$
					has_church_aspect = transmutative_path_sponsor_travelling_libraries
				}
			}
			add_next_institution_embracement = 15
		}
		else_if = {
			limit = {
				FROM = {
					has_country_flag = transmutative_path_meditation_through_labour_slot_$slot$
					has_church_aspect = transmutative_path_meditation_through_labour
				}
			}
			add_base_production = 1
		}
		else_if = {
			limit = {
				FROM = {
					has_country_flag = transmutative_path_fill_the_begging_bowls_slot_$slot$
					has_church_aspect = transmutative_path_fill_the_begging_bowls
				}
			}
			add_prosperity = 25
		}
		else_if = {
			limit = {
				FROM = {
					has_country_flag = transmutative_path_relive_past_lives_slot_$slot$
					has_church_aspect = transmutative_path_relive_past_lives
				}
			}
			add_nationalism = -10
		}
		else_if = {
			limit = {
				FROM = {
					has_country_flag = transmutative_path_universal_martial_education_slot_$slot$
					has_church_aspect = transmutative_path_universal_martial_education
				}
			}
			add_base_manpower = 1
		}
		else_if = {
			limit = {
				FROM = {
					has_country_flag = transmutative_path_leadership_of_hero_monks_slot_$slot$
					has_church_aspect = transmutative_path_leadership_of_hero_monks
				}
			}
			add_province_modifier = { name = transmutative_path_leadership_of_hero_monks_mod duration = 3650 }
		}
		else_if = {
			limit = {
				FROM = {
					has_country_flag = transmutative_path_hire_sellsword_monks_slot_$slot$
					has_church_aspect = transmutative_path_hire_sellsword_monks
				}
			}
			add_province_modifier = { name = transmutative_path_hire_sellsword_monks_mod duration = 3650 }
		}
		else_if = {
			limit = {
				FROM = {
					has_country_flag = transmutative_path_everything_under_heaven_slot_$slot$
					has_church_aspect = transmutative_path_everything_under_heaven
				}
			}
			add_province_modifier = { name = transmutative_path_everything_under_heaven_mod duration = 3650 }
		}
		else_if = {
			limit = {
				FROM = {
					has_country_flag = transmutative_path_through_inaction_action_slot_$slot$
					has_church_aspect = transmutative_path_through_inaction_action
				}
			}
			add_province_modifier = { name = transmutative_path_through_inaction_action_mod duration = 3650 }
		}
		else_if = {
			limit = {
				FROM = {
					has_country_flag = transmutative_path_we_all_lift_together_slot_$slot$
					has_church_aspect = transmutative_path_we_all_lift_together
				}
			}
			add_province_modifier = { name = transmutative_path_we_all_lift_together_mod duration = 3650 }
		}
		else_if = {
			limit = {
				FROM = {
					has_country_flag = transmutative_path_the_second_ascension_slot_$slot$
					has_church_aspect = transmutative_path_the_second_ascension
				}
			}
			add_prosperity = 10
			owner = { add_splendor = 5 }
		}
		else_if = {
			limit = {
				FROM = {
					has_country_flag = transmutative_path_sages_of_the_misty_mountains_slot_$slot$
					has_church_aspect = transmutative_path_sages_of_the_misty_mountains
				}
			}
			add_province_modifier = { name = transmutative_path_sages_of_the_misty_mountains_mod duration = 3650 }
		}
		else_if = {
			limit = {
				FROM = {
					has_country_flag = transmutative_path_flavor_of_life_slot_$slot$
					has_church_aspect = transmutative_path_flavor_of_life
				}
			}
			add_province_modifier = { name = transmutative_path_flavor_of_life_mod duration = 3650 }
			add_prosperity = 10
		}
	}
}
